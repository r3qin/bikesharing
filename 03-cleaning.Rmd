# Data transformation
Import the packages.
```{r message=FALSE, warning=FALSE}
library(dplyr)
library(purrr)
library(prob)
library(ggplot2)
library(ggridges)
library(tidyverse)
library(lubridate)
```

Create a folder to store transformed data.
```{r}
if (!file.exists("data")) {
  dir.create(file.path(getwd(), "data"))
}
```

Download the bike-sharing data from the website. Since not all downloaded files have the same correct extensions, we need to tweak the code a bit. 
# TODO: make sure this script can download the files AND change the download path to "data/bike_data"
```{r}
address = "https://s3.amazonaws.com/capitalbikeshare-data/201907-capitalbikeshare-tripdata.zip"
download.file(address, file.path("data", basename(address)))
unzip(file.path("data", basename(address)), "201907-capitalbikeshare-tripdata", exdir=file.path("data"))
file.rename(file.path("data", "201907-capitalbikeshare-tripdata"), file.path("data", "201907-capitalbikeshare-tripdata.csv"))
df = read.csv("data/201907-capitalbikeshare-tripdata.csv")
for (m in 1:12) {
  if (m == 7) {
    next
  }
  address = sprintf("https://s3.amazonaws.com/capitalbikeshare-data/2019%02d-capitalbikeshare-tripdata.zip",m)
  download.file(address, file.path("data", basename(address)))
  f = unzip(file.path("data", basename(address)), gsub(".zip", ".csv", basename(address)), exdir=file.path("data"))
  df = rbind(df, read.csv(f))
}
```

Load the data.
```{r}
folder_path = "data/bike_data"
# zip_path = "data/bike_data/201901-capitalbikeshare-tripdata.zip"
csv_path = "data/bike_data/201901-capitalbikeshare-tripdata.csv"
# unzip(zip_path, exdir=folder_path)
df_original = read.csv(csv_path)
for (m in 2:12) {
  # zip_path = sprintf("data/bike_data/2019%02d-capitalbikeshare-tripdata.zip", m)
  csv_path = sprintf("data/bike_data/2019%02d-capitalbikeshare-tripdata.csv", m)
  # if (m == 7) {
  #   file.rename("data/bike_data/201907-capitalbikeshare-tripdata", csv_path)
  # }
  # unzip(zip_path, exdir=folder_path)
  df_original = rbind(df_original, read.csv(csv_path))
}
```

# TODO: split the code
```{r}
# drop unnecessary variables
df = df_original %>% select(c(1, 2, 3, 9))

# create variables regarding date and time
t_start = strptime(as.character(df$Start.date), "%Y-%m-%d %H:%M:%S")
df$date = as.character(date(t_start))
df$year = year(t_start)
df$month = month(t_start, label=TRUE)
df$day = day(t_start)
df$hour = hour(t_start)
df = df %>% select(!c("Start.date", "End.date"))

# add the variable: day of week
df$weekday = weekdays(as.Date(df$date, "%Y-%m-%d"), abbreviate=TRUE)
# holidays of 2011 and 2012
holidays = c("2019-01-01","2019-01-21", "2019-02-18", "2019-04-13", "2019-05-27", "2019-07-04", "2019-09-02",
             "2019-10-14", "2019-11-11", "2019-11-28", "2019-12-25")
# add a variable to check if the bike sharing happened on a workday
df$holiday = df$date %in% holidays
df$workingday = !(df$weekday %in% c("Sat", "Sun") | df$holiday)
df$holiday = recode_factor(as.factor(df$holiday), "TRUE" = "yes", "FALSE" = "no")
df$workingday = recode_factor(as.factor(df$workingday), "TRUE" = "yes", "FALSE" = "no")
```

Get a summary of the dataset.
```{r}
### Test cell
Hmisc::describe(df)
```

# TODO: Save the dataframe.
```{r}

```


# TODO: split the code, generate the merged data frame and save it
```{r}
# read temperature data
temp = read.csv("temp_data/temp.csv")
# change date format
temp$DATE = format(strptime(as.character(temp$DATE), "%m/%d/%Y"), "%Y-%m-%d")
# merge two data frames on date
df = left_join(df, temp, by = c("start_date" = "DATE"))
# add the variable: day of week
df$weekday = weekdays(as.Date(df$start_date, "%Y-%m-%d"))
# holidays of 2011 and 2012
holidays = c("2019-01-01","2019-01-21", "2019-02-18", "2019-04-13", "2019-05-27", "2019-07-04", "2019-09-02",
             "2019-10-14", "2019-11-11", "2019-11-28", "2019-12-25")
# add a variable to check if the bike sharing happened on a workday
df$holidays = df$start_date %in% holidays
df$workdays = !(df$weekday %in% c("Saturday", "Sunday") | df$holidays)
df$workdays = recode_factor(as.factor(df$workdays), "TRUE" = "Workdays", "FALSE" = "Non-workdays")
df = df %>% select(!c("weekday", "holidays", "start_date", "Duration"))
df = df %>% 
  group_by(Year, Month, Day, Hour, PRCP, SNOW, SNWD, TAVG, TMAX, TMIN, workdays, Member.type) %>%
  count(name="num")
```



